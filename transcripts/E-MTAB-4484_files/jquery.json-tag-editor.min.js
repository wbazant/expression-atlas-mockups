"use strict";!function(a){a.fn.jsonTagEditor=function(b,c,d){function e(a){return a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function f(a){try{return JSON.parse(a).map(function(a){return h(JSON.stringify(a))}).filter(function(a){return a})}catch(b){return a.split(l.dregex).map(function(a){return a.trim().length>0?{value:a.trim()}:!1}).filter(function(a){return a})}}function g(a){return a.hasOwnProperty("value")&&"string"==typeof a.value&&a.value.trim().length>0}function h(a){try{var b=JSON.parse(a);if(g(b))return b}catch(c){}return String(a).trim().length>0?{value:String(a).trim()}:!1}function i(a,b){return b>-1&&a.length>b?a.substring(0,b-1)+"â€¦":a}function j(b,c){return 0===a(b).not(c).length&&0===a(c).not(b).length}var k,l=a.extend({},a.fn.jsonTagEditor.defaults,b),m=this;if(l.delimiter="	\n",l.dregex=new RegExp("["+l.delimiter+"]","g"),"string"==typeof b){var n=[];return m.each(function(){var e=a(this),f=e.data("options"),g=e.next(".json-tag-editor");switch(b){case"getTags":n.push({field:e[0],editor:g,tags:g.data("tags")});break;case"addTag":if(f.maxTags&&g.data("tags").length>=f.maxTags)return!1;a("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+f.delimiter[0]+"</div>").append('<div class="json-tag-editor-tag"></div>').append('<div class="json-tag-editor-delete"><i></i></div>').appendTo(g).find(".json-tag-editor-tag").append('<input type="text" maxlength="'+f.maxLength+'">').addClass("active").find("input").val(c).blur(),d?a(".placeholder",g).remove():g.click();break;case"removeTag":a(".json-tag-editor-tag",g).filter(function(){return a(this).get(0).dataset.value===c}).closest("li").find(".json-tag-editor-delete").click(),d||g.click();break;case"destroy":e.removeClass("json-tag-editor-hidden-src").removeData("options").off("focus.json-tag-editor").next(".json-tag-editor").remove();break;default:return this}}),"getTags"===b?n:this}return window.getSelection&&a(document).off("keydown.json-tag-editor").on("keydown.json-tag-editor",function(b){if(8===b.which||46===b.which){try{var c=getSelection(),d="BODY"===document.activeElement.tagName?a(c.getRangeAt(0).startContainer.parentNode).closest(".json-tag-editor"):0}catch(b){d=0}if(c.rangeCount>0&&d&&d.length)return a(".json-tag-editor-tag",d).each(function(){c.containsNode(a(this).get(0))&&a(this).closest("li").find(".json-tag-editor-delete").click()}),!1}}),m.each(function(){function c(){!l.placeholder||o.length||a(".deleted, .placeholder, input",p).length||p.append('<li class="placeholder"><div>'+l.placeholder+"</div></li>")}function d(b){var d=o;o=a(".json-tag-editor-tag:not(.deleted)",p).map(function(b,c){var d={};return a(this).hasClass("active")?(Object.assign(d,a(this).find("input").get(0).dataset),d.value=a(this).find("input").val()):Object.assign(d,a(c).get(0).dataset,{value:a(c).get(0).dataset.value}),d.value?d:void 0}).get(),p.data("tags",o),n.val(o.reduce(function(a,b){return a+l.delimiter[0]+b.value},"")),b||j(d,o)||l.onChange(n,p,o),c()}function m(b,c){for(var f,g=b.closest("li"),j=c?c.replace(/ +/," ").split(l.dregex):b.val().replace(/ +/," ").split(l.dregex),k=b.data("old_tag"),m=o.slice(0),q=!1,r=0;r<j.length;r++){var s=a.trim(j[r]).slice(0,l.maxLength);if(l.forceLowercase&&(s=s.toLowerCase()),f=l.beforeTagSave(n,p,m,k,s),s=f||s,f!==!1&&s){var t=h(s);if(t){for(var u=a('<div class="json-tag-editor-tag"'+(s.length>l.maxTagLength?' title="'+e(t.value)+'"':"")+">"+e(i(t.value,l.maxTagLength))+"</div>"),v=Object.keys(t),w=0;w<v.length;w++)u.get(0).dataset[v[w]]=t[v[w]];if(m.push(t),g.before(a("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+l.delimiter[0]+"</div>").append(u).append('<div class="json-tag-editor-delete"><i></i></div>')),l.maxTags&&m.length>=l.maxTags){q=!0;break}}}}b.closest("li").remove(),d()}var n=a(this),o=[],p=a("<ul "+(l.clickDelete?'oncontextmenu="return false;" ':"")+'class="json-tag-editor'+(b.noSelect?' noselect"':'"')+"></ul>").insertAfter(n);n.addClass("json-tag-editor-hidden-src").data("options",l).on("focus.json-tag-editor",function(){p.click()}),p.append('<li style="width:1px">&nbsp;</li>');var q='<li><div class="json-tag-editor-spacer">&nbsp;'+l.delimiter[0]+'</div><div class="json-tag-editor-tag"></div><div class="json-tag-editor-delete"><i></i></div></li>';p.click(function(b,c){var d,e,f=99999;if(!window.getSelection||""===getSelection().toString())return l.maxTags&&p.data("tags").length>=l.maxTags?(p.find("input").blur(),!1):(k=!0,a("input:focus",p).blur(),k?(k=!0,a(".placeholder",p).remove(),c&&c.length?e="before":a(".json-tag-editor-tag",p).each(function(){var g=a(this),h=g.offset(),i=h.left,j=h.top;b.pageY>=j&&b.pageY<=j+g.height()&&(b.pageX<i?(e="before",d=i-b.pageX):(e="after",d=b.pageX-i-g.width()),f>d&&(f=d),c=g)}),"before"===e?a(q).insertBefore(c.closest("li")).find(".json-tag-editor-tag").click():"after"===e?a(q).insertAfter(c.closest("li")).find(".json-tag-editor-tag").click():a(q).appendTo(p).find(".json-tag-editor-tag").click(),!1):!1)}),p.on("click",".json-tag-editor-delete",function(b){if(a(this).prev().hasClass("active"))return a(this).closest("li").find("input").caret(-1),!1;var e=a(this).closest("li"),f=e.find(".json-tag-editor-tag");return l.beforeTagDelete(n,p,o,f.text())===!1?!1:(f.addClass("deleted").animate({width:0},l.animateDelete,function(){e.remove(),c()}),d(),!1)}),l.clickDelete&&p.on("mousedown",".json-tag-editor-tag",function(b){if(b.ctrlKey||b.which>1){var e=a(this).closest("li"),f=e.find(".json-tag-editor-tag");return l.beforeTagDelete(n,p,o,f.text())===!1?!1:(f.addClass("deleted").animate({width:0},l.animateDelete,function(){e.remove(),c()}),d(),!1)}}),p.on("click",".json-tag-editor-tag",function(b){if(l.clickDelete&&(b.ctrlKey||b.which>1))return!1;if(!a(this).hasClass("active")){var c=a(this).get(0).dataset.value?a(this).get(0).dataset.value:a(this).text(),d=a(this).text(),f=Math.abs((a(this).offset().left-b.pageX)/a(this).width()),g=parseInt(d.length*f),h=a(this).html('<input type="text" maxlength="'+l.maxLength+'" value="'+e(c)+'">').addClass("active").find("input");if(h.data("old_tag",c).focus().caret(g),l.autocomplete){var i=a.extend({},l.autocomplete),j="select"in i?l.autocomplete.select:"";i.select=function(b,c){j&&j(b,c),setTimeout(function(){p.trigger("click",[a(".active",p).find("input").closest("li").next("li").find(".json-tag-editor-tag")])},20)},i.plugin?h[i.plugin](i):h.autocomplete(i),i._renderItem&&(h.autocomplete("instance")._renderItem=i._renderItem)}}return!1});var r=!1;p.on("onTreeExpansionHit",function(a){r=!0}),p.on("onTreeNoExpansionHit",function(a){r=!1}),p.on("blur","input",function(b){b.stopPropagation();var f=a(this),g=f.data("old_tag"),j=a.trim(f.val().replace(/ +/," ").replace(l.dregex,l.delimiter[0]));if(j){if(j.indexOf(l.delimiter[0])>=0)return void m(f);if(j!=g){l.forceLowercase&&(j=j.toLowerCase());var q=l.beforeTagSave(n,p,o,g,j);if(j=q||j,q===!1){if(g)return f.val(g).focus(),k=!1,void d();try{f.closest("li").remove()}catch(b){}g&&d()}}}else{if(g&&l.beforeTagDelete(n,p,o,g)===!1)return f.val(g).focus(),k=!1,void d();try{f.closest("li").remove()}catch(b){}g&&d()}var s=f.parent(),t=h(j);if(t&&!r){for(var u=Object.keys(t),v=0;v<u.length;v++)s.get(0).dataset[u[v]]=t[u[v]];t.value.length>l.maxTagLength?s.attr("title",e(t.value)):s.removeAttr("title"),s.html(e(i(t.value,l.maxTagLength))).removeClass("active")}j!=g&&d(),p.trigger("onBlurHideResults"),c()}),p.on("paste","input",function(b){var c,d;a(this).removeAttr("maxlength"),c=(b.originalEvent||b).clipboardData.getData("text/plain"),d=a(this),setTimeout(function(){m(d,c)},30)}),p.on("keypress","input",function(b){if(l.delimiter.indexOf(String.fromCharCode(b.which))>=0){var c=a(this);setTimeout(function(){m(c)},20)}}),p.on("keydown","input",function(b){var c,d,e=a(this);if((37===b.which||!l.autocomplete&&38===b.which)&&!e.caret()||8===b.which&&!e.val())return c=e.closest("li").prev("li").find(".json-tag-editor-tag"),c.length?c.click().find("input").caret(-1):!e.val()||l.maxTags&&p.data("tags").length>=l.maxTags||a(q).insertBefore(e.closest("li")).find(".json-tag-editor-tag").click(),!1;if((39===b.which||!l.autocomplete&&40===b.which)&&e.caret()===e.val().length)return d=e.closest("li").next("li").find(".json-tag-editor-tag"),d.length?d.click().find("input").caret(0):e.val()&&!r&&p.click(),!1;if(9===b.which){if(b.shiftKey){if(c=e.closest("li").prev("li").find(".json-tag-editor-tag"),c.length)c.click().find("input").caret(0);else{if(!e.val()||l.maxTags&&p.data("tags").length>=l.maxTags)return n.attr("disabled","disabled"),void setTimeout(function(){n.removeAttr("disabled")},30);a(q).insertBefore(e.closest("li")).find(".json-tag-editor-tag").click()}return!1}if(d=e.closest("li").next("li").find(".json-tag-editor-tag"),d.length)d.click().find("input").caret(0);else{if(!e.val())return;p.click()}return!1}if(!(46!==b.which||a.trim(e.val())&&e.caret()!==e.val().length))return d=e.closest("li").next("li").find(".json-tag-editor-tag"),d.length?d.click().find("input").caret(0):e.val()&&p.click(),!1;if(13===b.which)return p.trigger("click",[e.closest("li").next("li").find(".json-tag-editor-tag")]),l.maxTags&&p.data("tags").length>=l.maxTags&&p.find("input").blur(),!1;if(36!==b.which||e.caret()){if(35===b.which&&e.caret()===e.val().length)p.find(".json-tag-editor-tag").last().click();else if(27===b.which)return e.val(e.data("old_tag")?e.data("old_tag"):"").blur(),!1}else p.find(".json-tag-editor-tag").first().click()});for(var s=l.initialTags.length?l.initialTags.map(function(a){return g(a)?a:h(a)}):f(n.val()),t=0;t<s.length&&!(l.maxTags&&t>=l.maxTags);t++){var u=s[t];if(u){l.forceLowercase&&(u.value=u.value.toLowerCase()),o.push(u);for(var v=a('<div class="json-tag-editor-tag"'+(u.length>l.maxTagLength?' title="'+e(u.value)+'"':"")+">"+e(i(u.value,l.maxTagLength))+"</div>"),w=Object.keys(u),x=0;x<w.length;x++)v.get(0).dataset[w[x]]=u[w[x]];p.append(a("<li></li>").append('<div class="json-tag-editor-spacer">&nbsp;'+l.delimiter[0]+"</div>").append(v).append('<div class="json-tag-editor-delete"><i></i></div>'))}}d(!0),l.sortable&&a.fn.sortable&&p.sortable({distance:5,cancel:".json-tag-editor-spacer, input",helper:"clone",update:function(){d()}})})},a.fn.jsonTagEditor.defaults={initialTags:[],maxTags:0,maxLength:50,maxTagLength:-1,placeholder:"",forceLowercase:!1,clickDelete:!1,animateDelete:175,noSelect:!1,sortable:!0,autocomplete:null,onChange:function(){},beforeTagSave:function(){},beforeTagDelete:function(){}}}(jQuery);